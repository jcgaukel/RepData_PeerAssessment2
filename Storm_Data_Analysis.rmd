---
title: "Storm Data"
output: html_document
keep_md: yes
pdf_document: default
word_document: default
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(message=FALSE, warning=FALSE, fig.width = 12)
```

## Synopsis
The purpose of this analysis is to help answer the following questions:
* Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
* Across the United States, which types of events have the greatest economic consequences?


## Data Processing

[National Weather Service Storm Data Documentation](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2Fpd01016005curr.pdf)

[National Climatic Data Center Storm Events FAQ](https://d396qusza40orc.cloudfront.net/repdata%2Fpeer2_doc%2FNCDC%20Storm%20Events-FAQ%20Page.pdf)

```{r load_and_preprocess, cache=FALSE}
# loading all required libraries
library(tools)
library(ggplot2)
library(plyr)
library(stringr)
library(R.utils)

# file information (downloaded on 4/21/2015 3:20 PM CDT)
filelink <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
filename <- "repdata_data_StormData.csv.bz2"
filechecksum <- "df4aa61fff89427db6b7f7b1113b5553"  
extractedfile <- "Extracted Data/repdata_data_StormData.csv"
extractedfilechecksum <- "33ab0bd27d935eeefef0dd7300f800af"

# check to see if file is missing or checksum has changed 
if (!file.exists(filename)|md5sum(filename) != filechecksum) {
        # download the file.
        download.file(filelink, filename)
        }

# check to see if the extracted file exists or the checksum doesn't match
if (!file.exists(extractedfile) | md5sum(extractedfile) != extractedfilechecksum) {
        # extract file
        bunzip2(filename = filename, destname = extractedfile)
        }

# read in data file
# sd <- read.csv(bzfile(filename))
#sd <- read.csv(extractedfile)        


# functions to validate, and clean up / stanardize event types
# keep this for debugging.
check.EVTYPE <- function(x){
        valid.EVTYPE <- c("ASTRONOMICAL LOW TIDE",
                          "AVALANCHE",
                          "BLIZZARD",
                          "COASTAL FLOOD",
                          "COLD/WIND CHILL",
                          "DEBRIS FLOW",
                          "DENSE FOG",
                          "DENSE SMOKE",
                          "DROUGHT",
                          "DUST DEVIL",
                          "DUST STORM",
                          "EXCESSIVE HEAT",
                          "EXTREME COLD/WIND CHILL",
                          "FLASH FLOOD",
                          "FLOOD",
                          "FROST/FREEZE",
                          "FUNNEL CLOUD",
                          "FREEZING FOG",
                          "HAIL",
                          "HEAT",
                          "HEAVY RAIN",
                          "HEAVY SNOW",
                          "HIGH SURF",
                          "HIGH WIND",
                          "HURRICANE (TYPHOON)",
                          "ICE STORM",
                          "LAKE-EFFECT SNOW",
                          "LAKESHORE FLOOD",
                          "LIGHTNING",
                          "MARINE HAIL",
                          "MARINE HIGH WIND",
                          "MARINE STRONG WIND",
                          "MARINE THUNDERSTORM WIND",
                          "RIP CURRENT",
                          "SEICHE",
                          "SLEET",
                          "STORM SURGE/TIDE",
                          "STRONG WIND",
                          "THUNDERSTORM WIND",
                          "TORNADO",
                          "TROPICAL DEPRESSION",
                          "TROPICAL STORM",
                          "TSUNAMI",
                          "VOLCANIC ASH",
                          "WATERSPOUT",
                          "WILDFIRE",
                          "WINTER STORM",
                          "WINTER WEATHER")
        
        return(match(x, valid.EVTYPE, nomatch = 0))
        }
        
        
clean.EVTYPE <- function(x){
        library(stringr)
        valid.EVTYPE <- c("ASTRONOMICAL LOW TIDE",
                          "AVALANCHE",
                          "BLIZZARD",
                          "COASTAL FLOOD",
                          "COLD/WIND CHILL",
                          "DEBRIS FLOW",
                          "DENSE FOG",
                          "DENSE SMOKE",
                          "DROUGHT",
                          "DUST DEVIL",
                          "DUST STORM",
                          "EXCESSIVE HEAT",
                          "EXTREME COLD/WIND CHILL",
                          "FLASH FLOOD",
                          "FLOOD",
                          "FROST/FREEZE",
                          "FUNNEL CLOUD",
                          "FREEZING FOG",
                          "HAIL",
                          "HEAT",
                          "HEAVY RAIN",
                          "HEAVY SNOW",
                          "HIGH SURF",
                          "HIGH WIND",
                          "HURRICANE (TYPHOON)",
                          "ICE STORM",
                          "LAKE-EFFECT SNOW",
                          "LAKESHORE FLOOD",
                          "LIGHTNING",
                          "MARINE HAIL",
                          "MARINE HIGH WIND",
                          "MARINE STRONG WIND",
                          "MARINE THUNDERSTORM WIND",
                          "RIP CURRENT",
                          "SEICHE",
                          "SLEET",
                          "STORM SURGE/TIDE",
                          "STRONG WIND",
                          "THUNDERSTORM WIND",
                          "TORNADO",
                          "TROPICAL DEPRESSION",
                          "TROPICAL STORM",
                          "TSUNAMI",
                          "VOLCANIC ASH",
                          "WATERSPOUT",
                          "WILDFIRE",
                          "WINTER STORM",
                          "WINTER WEATHER")

        # remove spaces before and after
        new.EVTYPE <- str_trim(x, side="both")
        
        # change to upper case
        new.EVTYPE <- toupper(new.EVTYPE)
        
        # remove misc punctuation
        new.EVTYPE <- sub("\\.$", "", new.EVTYPE)
        new.EVTYPE <- sub(";$", "", new.EVTYPE)
        
        new.EVTYPE <- sub("\\(", " ", new.EVTYPE) # note: this will break "HURRICANE (TYPHOON)", but we fix it later
        new.EVTYPE <- sub(")$", "", new.EVTYPE)   # note: this will break "HURRICANE (TYPHOON)", but we fix it later
        
        
        # remove all double spaces within value
        while(length(grep("  ", new.EVTYPE)) > 0){new.EVTYPE <- sub("  ", " ", new.EVTYPE)}
        
        # remove spaces before and after slashes and stanardize them
        new.EVTYPE <- sub("-", "/", new.EVTYPE)
        new.EVTYPE <- sub(";", "/", new.EVTYPE)
        new.EVTYPE <- sub("\\\\", "/", new.EVTYPE)
        new.EVTYPE <- sub("/ ", "/", new.EVTYPE)
        new.EVTYPE <- sub(" /", "/", new.EVTYPE)
        
        # replace abbreviations
        new.EVTYPE <- sub("TSTM ", "THUNDERSTORM ", new.EVTYPE)
        
        # fix typos
        new.EVTYPE <- sub("^AVALANCE$", "AVALANCHE", new.EVTYPE)
        new.EVTYPE <- sub("THUNDERTORM", "THUNDERSTORM", new.EVTYPE)
        new.EVTYPE <- sub("^THUNDERSTORMW$", "THUNDERSTORM", new.EVTYPE)
        
        # remove plurals
        new.EVTYPE <- sub("CURRENTS$", "CURRENT", new.EVTYPE)
        new.EVTYPE <- sub("WINDS$", "WIND", new.EVTYPE)
        new.EVTYPE <- sub("STORMS", "STORM", new.EVTYPE)

        # coerce into standard event types
        #new.EVTYPE <- sub("^$", "", new.EVTYPE)
        new.EVTYPE <- sub("^COLD$", "COLD/WIND CHILL", new.EVTYPE)
        new.EVTYPE <- sub("^EXTREME COLD$", "EXTREME COLD/WIND CHILL", new.EVTYPE)
        new.EVTYPE <- sub("^EXTREME HEAT$", "EXCESSIVE HEAT", new.EVTYPE)
        new.EVTYPE <- sub("^FLASH FLOODING$", "FLASH FLOOD", new.EVTYPE)
        new.EVTYPE <- sub("^FOG$", "DENSE FOG", new.EVTYPE)
        new.EVTYPE <- sub("^GUSTY WIND$", "STRONG WIND", new.EVTYPE)
        new.EVTYPE <- sub("^HEAT WAVE$", "HEAT", new.EVTYPE)
        new.EVTYPE <- sub("^HEAVY SNOW AND HIGH WINDS$", "BLIZZARD", new.EVTYPE)
        new.EVTYPE <- sub("^HEAVY SURF/HIGH SURF$", "HIGH SURF", new.EVTYPE)
        new.EVTYPE <- sub("^HEAVY SURF$", "HIGH SURF", new.EVTYPE)
        new.EVTYPE <- sub("^HURRICANE .*$", "HURRICANE (TYPHOON)", new.EVTYPE)
        new.EVTYPE <- sub("^HURRICANE/TYPHOON$", "HURRICANE (TYPHOON)", new.EVTYPE)
        new.EVTYPE <- sub("^HURRICANE$", "HURRICANE (TYPHOON)", new.EVTYPE)
        new.EVTYPE <- sub("^ICE$", "ICE STORM", new.EVTYPE)
        new.EVTYPE <- sub("^LIGHTNING", "LIGHTNING", new.EVTYPE)
        new.EVTYPE <- sub("^STORM SURGE$", "STORM SURGE/TIDE", new.EVTYPE)
        new.EVTYPE <- sub("^THUNDERSTORM$", "THUNDERSTORM WIND", new.EVTYPE)
        new.EVTYPE <- sub("^THUNDERSTORM WIND.*$", "THUNDERSTORM WIND", new.EVTYPE)
        new.EVTYPE <- sub("^TROPICAL STORM GORDON$", "TROPICAL STORM", new.EVTYPE)
        new.EVTYPE <- sub("^WATERSPOUT/TORNADO$", "TORNADO", new.EVTYPE)
        new.EVTYPE <- sub("^WILD FIRES$", "WILDFIRE", new.EVTYPE)
        new.EVTYPE <- sub("^WILD/FOREST FIRE$", "WILDFIRE", new.EVTYPE)
        new.EVTYPE <- sub("^WINTER WEATHER MIX$", "WINTER WEATHER", new.EVTYPE)
        new.EVTYPE <- sub("^WINTER WEATHER/MIX$", "WINTER WEATHER", new.EVTYPE)
        new.EVTYPE <- sub("^WINTRY MIX$", "WINTER WEATHER", new.EVTYPE)
        
        # anything that isn't matched gets lumped together as "UNKNOWN/OTHER"
        missing.EVTYPE <- !(new.EVTYPE %in% valid.EVTYPE)
        
        for (i in 1:length(new.EVTYPE)) {
                if(missing.EVTYPE[i] == TRUE) new.EVTYPE[i] <- "UNKNOWN/OTHER"
                }
        
        return(new.EVTYPE)
        
        }

```

## Results
### Health Impact

```{r health_impact}
# summarize the data by event type
sdh <- ddply(sd, c("EVTYPE"), summarize, INJ_FAT = sum(INJURIES + FATALITIES))

# remove any items where no one was injured or killed
sdh <- subset(sdh, sdh$INJ_FAT != 0)

# clean up remaining event types
sdh$EVTYPE <- clean.EVTYPE(sdh$EVTYPE)
#sdh$new.EVTYPE <- clean.EVTYPE(sdh$EVTYPE) # for debugging

# resummarize on cleaned up event types
sdh <- ddply(sdh, c("EVTYPE"), summarize, INJ_FAT = sum(INJ_FAT))

# for debugging
# sdh$match <- check.EVTYPE(sdh$new.EVTYPE)
# write.csv(sdh, "sdh.csv")

# grab top 10 event types
sdh_10 <- head(sdh[with(sdh, order(-INJ_FAT, EVTYPE)),], 10)

# plot them
ggplot(sdh_10, 
       aes(reorder(x=factor(EVTYPE), 
                   -INJ_FAT
                   ),
           y=INJ_FAT
           )
       ) +
        geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle= 90,
                                         hjust = 1)
              ) +
        labs(title = "Top Weather Events Causing Injuries and/or Fatalities",
             x = "Weather Event Type",
             y = "Number of Injuries and/or Fatalities")
```

### Ecomnomic Impact
```{r economic_impact}



```



## Results







